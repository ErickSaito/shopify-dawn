"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _get(){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var i=_superPropBase(e,t);if(i){var n=Object.getOwnPropertyDescriptor(i,t);return n.get?n.get.call(arguments.length<3?e:r):n.value}}).apply(this,arguments)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(e){var t=_isNativeReflectConstruct();return function(){var r,i=_getPrototypeOf(e);if(t){var n=_getPrototypeOf(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return _possibleConstructorReturn(this,r)}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var PredictiveSearch=function(e){_inherits(r,SearchForm);var t=_createSuper(r);function r(){var e;return _classCallCheck(this,r),(e=t.call(this)).cachedResults={},e.predictiveSearchResults=e.querySelector("[data-predictive-search]"),e.allPredictiveSearchInstances=document.querySelectorAll("predictive-search"),e.isOpen=!1,e.abortController=new AbortController,e.searchTerm="",e.setupEventListeners(),e}return _createClass(r,[{key:"setupEventListeners",value:function(){this.input.form.addEventListener("submit",this.onFormSubmit.bind(this)),this.input.addEventListener("focus",this.onFocus.bind(this)),this.addEventListener("focusout",this.onFocusOut.bind(this)),this.addEventListener("keyup",this.onKeyup.bind(this)),this.addEventListener("keydown",this.onKeydown.bind(this))}},{key:"getQuery",value:function(){return this.input.value.trim()}},{key:"onChange",value:function(){_get(_getPrototypeOf(r.prototype),"onChange",this).call(this);var e,t=this.getQuery();this.searchTerm&&t.startsWith(this.searchTerm)||(null===(e=this.querySelector("#predictive-search-results-groups-wrapper"))||void 0===e||e.remove());this.updateSearchForTerm(this.searchTerm,t),this.searchTerm=t,this.searchTerm.length?this.getSearchResults(this.searchTerm):this.close(!0)}},{key:"onFormSubmit",value:function(e){this.getQuery().length&&!this.querySelector('[aria-selected="true"] a')||e.preventDefault()}},{key:"onFormReset",value:function(e){_get(_getPrototypeOf(r.prototype),"onFormReset",this).call(this,e),_get(_getPrototypeOf(r.prototype),"shouldResetForm",this).call(this)&&(this.searchTerm="",this.abortController.abort(),this.abortController=new AbortController,this.closeResults(!0))}},{key:"onFocus",value:function(){var e=this.getQuery();e.length&&(this.searchTerm!==e?this.onChange():"true"===this.getAttribute("results")?this.open():this.getSearchResults(this.searchTerm))}},{key:"onFocusOut",value:function(){var e=this;setTimeout(function(){e.contains(document.activeElement)||e.close()})}},{key:"onKeyup",value:function(e){switch(this.getQuery().length||this.close(!0),e.preventDefault(),e.code){case"ArrowUp":this.switchOption("up");break;case"ArrowDown":this.switchOption("down");break;case"Enter":this.selectOption()}}},{key:"onKeydown",value:function(e){"ArrowUp"!==e.code&&"ArrowDown"!==e.code||e.preventDefault()}},{key:"updateSearchForTerm",value:function(e,t){var r=this.querySelector("[data-predictive-search-search-for-text]"),i=null==r?void 0:r.innerText;if(i){if(i.match(new RegExp(e,"g")).length>1)return;var n=i.replace(e,t);r.innerText=n}}},{key:"switchOption",value:function(e){if(this.getAttribute("open")){var t="up"===e,r=this.querySelector('[aria-selected="true"]'),i=Array.from(this.querySelectorAll("li, button.predictive-search__item")).filter(function(e){return null!==e.offsetParent}),n=0;if(!t||r){for(var o=-1,s=0;-1===o&&s<=i.length;)i[s]===r&&(o=s),s++;if(this.statusElement.textContent="",!t&&r?n=o===i.length-1?0:o+1:t&&(n=0===o?i.length-1:o-1),n!==o){var u=i[n];u.setAttribute("aria-selected",!0),r&&r.setAttribute("aria-selected",!1),this.input.setAttribute("aria-activedescendant",u.id)}}}}},{key:"selectOption",value:function(){var e=this.querySelector('[aria-selected="true"] a, button[aria-selected="true"]');e&&e.click()}},{key:"getSearchResults",value:function(e){var t=this,r=e.replace(" ","-").toLowerCase();this.setLiveRegionLoadingState(),this.cachedResults[r]?this.renderSearchResults(this.cachedResults[r]):fetch("".concat(routes.predictive_search_url,"?q=").concat(encodeURIComponent(e),"&section_id=predictive-search"),{signal:this.abortController.signal}).then(function(e){if(!e.ok){var r=new Error(e.status);throw t.close(),r}return e.text()}).then(function(e){var i=(new DOMParser).parseFromString(e,"text/html").querySelector("#shopify-section-predictive-search").innerHTML;t.allPredictiveSearchInstances.forEach(function(e){e.cachedResults[r]=i}),t.renderSearchResults(i)}).catch(function(e){if(20!==(null==e?void 0:e.code))throw t.close(),e})}},{key:"setLiveRegionLoadingState",value:function(){this.statusElement=this.statusElement||this.querySelector(".predictive-search-status"),this.loadingText=this.loadingText||this.getAttribute("data-loading-text"),this.setLiveRegionText(this.loadingText),this.setAttribute("loading",!0)}},{key:"setLiveRegionText",value:function(e){var t=this;this.statusElement.setAttribute("aria-hidden","false"),this.statusElement.textContent=e,setTimeout(function(){t.statusElement.setAttribute("aria-hidden","true")},1e3)}},{key:"renderSearchResults",value:function(e){this.predictiveSearchResults.innerHTML=e,this.setAttribute("results",!0),this.setLiveRegionResults(),this.open()}},{key:"setLiveRegionResults",value:function(){this.removeAttribute("loading"),this.setLiveRegionText(this.querySelector("[data-predictive-search-live-region-count-value]").textContent)}},{key:"getResultsMaxHeight",value:function(){return this.resultsMaxHeight=window.innerHeight-document.querySelector(".section-header").getBoundingClientRect().bottom,this.resultsMaxHeight}},{key:"open",value:function(){this.predictiveSearchResults.style.maxHeight=this.resultsMaxHeight||"".concat(this.getResultsMaxHeight(),"px"),this.setAttribute("open",!0),this.input.setAttribute("aria-expanded",!0),this.isOpen=!0}},{key:"close",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.closeResults(e),this.isOpen=!1}},{key:"closeResults",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&(this.input.value="",this.removeAttribute("results"));var e=this.querySelector('[aria-selected="true"]');e&&e.setAttribute("aria-selected",!1),this.input.setAttribute("aria-activedescendant",""),this.removeAttribute("loading"),this.removeAttribute("open"),this.input.setAttribute("aria-expanded",!1),this.resultsMaxHeight=!1,this.predictiveSearchResults.removeAttribute("style")}}]),r}();customElements.define("predictive-search",PredictiveSearch);